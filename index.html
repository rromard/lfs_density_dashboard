<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.37">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Ryan Romard">

<title>A Data Portrait of Canadian Unions</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="index_files/libs/clipboard/clipboard.min.js"></script>
<script src="index_files/libs/quarto-html/quarto.js"></script>
<script src="index_files/libs/quarto-html/popper.min.js"></script>
<script src="index_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="index_files/libs/quarto-html/anchor.min.js"></script>
<link href="index_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="index_files/libs/quarto-html/quarto-syntax-highlighting-29e2c20b02301cfff04dc8050bf30c7e.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="index_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="index_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="index_files/libs/bootstrap/bootstrap-7786cb578b94f462c7202f39f824e025.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="index_files/libs/quarto-dashboard/quarto-dashboard.js"></script>
<script src="index_files/libs/quarto-dashboard/stickythead.js"></script>
<script src="index_files/libs/quarto-dashboard/datatables.min.js" kdttablesentinel="true"></script>
<script src="index_files/libs/quarto-dashboard/pdfmake.min.js" kdttablesentinel="true"></script>
<script src="index_files/libs/quarto-dashboard/vfs_fonts.js" kdttablesentinel="true"></script>
<script src="index_files/libs/quarto-dashboard/web-components.js" type="module"></script>
<script src="index_files/libs/quarto-dashboard/components.js"></script>
<link href="index_files/libs/quarto-dashboard/datatables.min.css" rel="stylesheet" kdttablesentinel="true">


<link rel="stylesheet" href="styles.scss">
</head>

<body class="quarto-dashboard dashboard-fill dashboard-sidebar dashboard-toolbar fullcontent">

<header id="quarto-dashboard-header">
<nav class="navbar navbar-expand-md slim" data-bs-theme="dark">
  <div class="navbar-container container-fluid">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#dashboard-collapse" aria-controls="dashboard-collapse" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>    


    <div class="navbar-brand-container">       

      <div class="navbar-title">
        <div class="navbar-title-text"><a href="#">A Data Portrait of Canadian Unions</a></div>
        
        <div class="navbar-author">Ryan Romard</div>
      </div>
    </div>
<div id="dashboard-collapse" class="navbar-collapse collapse"><ul class="navbar-nav navbar-nav-scroll me-auto" role="tablist"><li class="nav-item" role="presentation"><a id="tab-home" class="nav-link active" data-bs-toggle="tab" role="tab" data-bs-target="#home" data-scrolling="false" href="#home" aria-controls="home" aria-selected="true"><span class="nav-link-text">Home</span></a></li><li class="nav-item" role="presentation"><a id="tab-info" class="nav-link" data-bs-toggle="tab" role="tab" data-bs-target="#info" data-scrolling="true" href="#info" aria-controls="info" aria-selected="false"><span class="nav-link-text">Info</span></a></li><li class="nav-item" role="presentation"><a id="tab-charts" class="nav-link" data-bs-toggle="tab" role="tab" data-bs-target="#charts" data-scrolling="false" href="#charts" aria-controls="charts" aria-selected="false"><span class="nav-link-text">Charts</span></a></li><li class="nav-item" role="presentation"><a id="tab-table" class="nav-link" data-bs-toggle="tab" role="tab" data-bs-target="#table" data-scrolling="false" href="#table" aria-controls="table" aria-selected="false"><span class="nav-link-text">Table</span></a></li><li class="nav-item" role="presentation"><a id="tab-data" class="nav-link" data-bs-toggle="tab" role="tab" data-bs-target="#data" data-scrolling="false" href="#data" aria-controls="data" aria-selected="false"><span class="nav-link-text">Data</span></a></li></ul></div></div>
</nav>
</header>
<div class="page-layout-custom quarto-dashboard-content bslib-gap-spacing html-fill-container bslib-page-fill quarto-dashboard-pages">  

<div class="html-fill-item html-fill-container dashboard-toolbar-container toolbar-toplevel"><div class="toolbar html-fill-container" data-layout="flow">
<div class="cell-output-display">

</div>
<div class="cell-output-display no-overflow-x">
<div class="form-group shiny-input-container">
<label class="control-label" id="variable-label" for="variable">Select variable</label>
<div>
<select class="shiny-input-select form-control" id="variable"><option value="Province" selected="">Province</option>
<option value="CMA">CMA</option>
<option value="Age group">Age group</option>
<option value="Gender">Gender</option>
<option value="Family type">Family type</option>
<option value="Youngest child">Youngest child</option>
<option value="Education level">Education level</option>
<option value="Student status">Student status</option>
<option value="Immigration">Immigration</option>
<option value="Occupation">Occupation</option>
<option value="Industry">Industry</option>
<option value="Establishment size">Establishment size</option>
<option value="Firm size">Firm size</option>
<option value="Employment status">Employment status</option>
<option value="Job tenure">Job tenure</option></select>
</div>
</div>
</div>
<div class="cell-output-display no-overflow-x">
<div class="form-group shiny-input-container">
<label class="control-label" id="gg_layout-label" for="gg_layout">Layout</label>
<div>
<select class="shiny-input-select form-control" id="gg_layout"><option value="Vertical" selected="">Vertical</option>
<option value="Horizontal">Horizontal</option>
<option value="Stacked">Stacked</option></select>
</div>
</div>
</div>
<div class="cell-output-display no-overflow-x">
<div class="form-group shiny-input-container">
<label class="control-label" id="measure-label" for="measure">Measure</label>
<div>
<select class="shiny-input-select form-control" id="measure"><option value="Union density" selected="">Union density</option>
<option value="Distribution (%)">Distribution (%)</option>
<option value="Distribution (N)">Distribution (N)</option></select>
</div>
</div>
</div>
<div class="cell-output-display no-overflow-x">
<div class="form-group shiny-input-container shinyjs-hide">
<label class="control-label" id="ordering-label" for="ordering">Order</label>
<div>
<select class="shiny-input-select form-control" id="ordering"><option value="Default" selected="">Default</option>
<option value="Descending">Descending</option></select>
</div>
</div>
</div>
</div><div class="toolbar-content html-fill-item html-fill-container">
<div class="tab-content bslib-grid html-fill-item html-fill-container" style="display: grid; grid-template-rows: minmax(3em, 1fr); grid-auto-columns: minmax(0, 1fr);">
<div id="home" class="dashboard-page tab-pane show active html-fill-item html-fill-container" data-orientation="rows" data-scrolling="false" aria-labelledby="tab-home">
<div class="html-fill-item html-fill-container bslib-grid" style="display: grid; grid-template-rows: minmax(3em, max-content); grid-auto-columns: minmax(0, 1fr);">
<div class="card html-fill-item html-fill-container bslib-card" data-fill="false" data-bslib-card-init="" data-require-bs-caller="card()" data-full-screen="false">
<div class="card-body html-fill-item html-fill-container">
<span style="font-size:26px;"><b>A data portrait of Canadian unions</b></span>
<p><strong>This dashboard</strong> allows the user to visually explore open-access data on trade union membership in Canada. The data source is the <a href="https://www23.statcan.gc.ca/imdb-bmdi/pub/3701-eng.htm">Labour Force Survey</a> published by Statistics Canada. Patterns in union density and the makeup of union membership can be observed across 16 different variables related to demographics, employment, and geography.</p>
<ul>
<li><p><strong>INFO -</strong> tab to see more detailed information on the data source, variable definitions, measures and layouts.</p></li>
<li><p><strong>CHARTS -</strong> tab to view data visualizations. Use the top toolbar to select variables, change the measure type, or select another chart layout.</p></li>
<li><p><strong>TABLE -</strong> tab to view the chart data presented in tabular format for each sector.</p></li>
<li><p><strong>DATA -</strong> tab to download a .csv file containing the raw chart data.</p></li>
</ul>
<span style="font-size:26px;"><b>A brief history of union density in Canada</b></span>
<ul>
<li><p><strong>Grey zone:</strong> Prior to 1872, it was illegal for workers to organize unions in Canada. Following the passage of the Trade Union Act that year, unions existed in a legal grey zone. Workers were no longer legally forbidden from creating unions, however, they had virtually no legal rights or protections in that area. Employers had no obligation to bargain with their employees, nor to even abide by the terms of an agreement were one to be rarely signed.</p></li>
<li><p><strong>Post-war take-off:</strong> Unions would exit the grey zone at end of World War Two, which was capped off by a <a href="https://canadianlabour.ca/who-we-are/history/1945-windsors-ford-strike/">massive strike by Ford workers in Windsor in 1945</a>. In the wake of that strike, a system of formalized and legally bound collective bargaining was created, along the lines of the <a href="https://www.nlrb.gov/about-nlrb/who-we-are/our-history/1935-passage-of-the-wagner-act">Wagner</a> mode lof industrial relations adopted in the United States. A key legal ruling establishing what is known as <a href="https://canadianlabour.ca/who-we-are/history/the-rand-decision-everyone-who-benefits-should-contribute/"><em>the Rand Formula</em></a> established that all who benefit from a union contract should pay dues to the union. As a result, union membership and activity expanded greatly from 1940s to the mid 1960s.</p></li>
<li><p><strong>Public sector bargaining:</strong> While public sector workers could also form unions, they did not win the right to collective bargaining alongside their private sector counterparts. It was not until 1965 that public sector workers won the right to bargain - a victory won by an <a href="https://canadianlabour.ca/who-we-are/history/1965-public-service-workers-win-bargaining-rights/">illegal wildcat strike by postal workers</a>.</p></li>
<li><p><strong>The long decline:</strong> Union density hit a high point of 38% in 1986, which was a year of significant labour struggle. Throughout the neoliberal era, governments and employers alike have undermined unions and labour rights. Those attacks, along with structural changes in the global and national economy like off-shoring manufacturing jobs, caused a long-term decline in union density that has continued to this day.</p></li>
</ul>
<br>
<div id="datawrapper-vis-b2njK" style="min-height:486px" class="html-fill-item html-fill-container">
<script type="text/javascript" defer="" src="https://datawrapper.dwcdn.net/b2njK/embed.js" charset="utf-8" data-target="#datawrapper-vis-b2njK"></script>
<noscript>
<img src="https://datawrapper.dwcdn.net/b2njK/full.png">
</noscript>
</div>
<br>
<span style="font-size:26px;"><b>Why compare private and public sector?</b></span>
<p>The data is categorized by employment sector, distinguishing private from public sector dynamics. This approach recognizes the significant differences in union density and membership trends between sectors, without framing them in opposition to one another.</p>
<p>Unionization rates began high in the public sector and have slowly risen over time. In 1997, about 69% of public employees were unionized, growing to 73% by 2024. In the private sector, unionization rates have always much lower and have drastically diminished over time, falling from 19.3% in 1997 to just 13.5% in 2024.</p>
<p>One reason for this difference is that most bargaining in the public sector takes place at the industry-level. For example, in most provinces, the majority public sector workers (e.g., teachers or nurses) across the province are members of the same union. Most private sector workers, by contract, work in small to medium sized firms that stand alone.</p>
<p>Another reason is that public sector jobs cannot be off-shored in the same way private sector jobs can. Off-shoring manufacturing has caused employment to shift from more to less unionized industries, as manufacturing jobs are replaced with service industry jobs.</p>
<br>
<div id="datawrapper-vis-gZmUd" style="min-height:463px" class="html-fill-item html-fill-container">
<script type="text/javascript" defer="" src="https://datawrapper.dwcdn.net/gZmUd/embed.js" charset="utf-8" data-target="#datawrapper-vis-gZmUd"></script>
<noscript>
<img src="https://datawrapper.dwcdn.net/gZmUd/full.png">
</noscript>
</div>
</div>
<bslib-tooltip placement="auto" bsoptions="[]" data-require-bs-version="5" data-require-bs-caller="tooltip()">
    <template>Expand</template>
    <span class="bslib-full-screen-enter badge rounded-pill">
        <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" style="height:1em;width:1em;" aria-hidden="true" role="img"><path d="M20 5C20 4.4 19.6 4 19 4H13C12.4 4 12 3.6 12 3C12 2.4 12.4 2 13 2H21C21.6 2 22 2.4 22 3V11C22 11.6 21.6 12 21 12C20.4 12 20 11.6 20 11V5ZM4 19C4 19.6 4.4 20 5 20H11C11.6 20 12 20.4 12 21C12 21.6 11.6 22 11 22H3C2.4 22 2 21.6 2 21V13C2 12.4 2.4 12 3 12C3.6 12 4 12.4 4 13V19Z"></path></svg>
    </span>
</bslib-tooltip><script data-bslib-card-init="">bslib.Card.initializeAllCards();</script></div>
</div>
</div>
<div id="info" class="dashboard-page tab-pane grid-skip html-fill-item html-fill-container" data-orientation="rows" data-scrolling="true" aria-labelledby="tab-info">
<div class="html-fill-item html-fill-container bslib-grid" style="display: grid; grid-template-rows: minmax(3em, max-content) minmax(3em, max-content) minmax(3em, max-content); grid-auto-columns: minmax(0, 1fr);">
<div class="html-fill-item html-fill-container bslib-grid" style="display: grid; grid-template-columns: minmax(3em, 1fr);
grid-auto-rows: minmax(0, 1fr);">
<div class="card html-fill-item html-fill-container bslib-card" data-title="DATA SOURCE" data-fill="false" data-bslib-card-init="" data-require-bs-caller="card()" data-full-screen="false">
<div class="card-header"><div class="card-title html-fill-item html-fill-container"><span style="display: inline">
DATA SOURCE
</span></div></div>
<div class="card-body html-fill-item html-fill-container">
<ul>
<li><p><strong>Source:</strong> The source for all data beyond the home page is the <a href="https://www150.statcan.gc.ca/n1/en/catalogue/71M0001X">Labour Force Survey (LFS) Public Use Micro-data File (PUMF)</a> published by Statistics Canada. For more information about the Labour Force Survey, please see the <a href="https://www150.statcan.gc.ca/n1/pub/71-543-g/71-543-g2020001-eng.htm">official guide</a> produced by StatCan.</p></li>
<li><p><strong>Years covered:</strong> 2006 to current (2024)</p></li>
<li><p><strong>Estimates:</strong> Public use microdata files have been altered by StatCan to protect the privacy of respondents, so that they might be released as open-access data. Accordingly, estimates produced with a PUMF may vary slightly from officially published data produced by StatCan. The estimated values are provided as-is without any indicators of estimate quality, such as a coefficient of variation (cv) or confidence intervals.</p></li>
<li><p><strong>Population:</strong> Only the <strong>workforce of paid employees</strong> either in the public or private sector are included in this report. That means people that are not in the labour force, unemployed, self-employed or unpaid family workers are not included in counts and proportions.</p></li>
<li><p><strong>Exclusions:</strong> Some parts of the population are excluded from the LFS itself, including people living on reserves, full-time military personnel and institutionalized/incarcerated peoples.</p></li>
<li><p><strong>Updates:</strong> Data is refreshed on a monthly basis with a one month lag, following the PUMF release schedule.</p></li>
</ul>
</div>
<bslib-tooltip placement="auto" bsoptions="[]" data-require-bs-version="5" data-require-bs-caller="tooltip()">
    <template>Expand</template>
    <span class="bslib-full-screen-enter badge rounded-pill">
        <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" style="height:1em;width:1em;" aria-hidden="true" role="img"><path d="M20 5C20 4.4 19.6 4 19 4H13C12.4 4 12 3.6 12 3C12 2.4 12.4 2 13 2H21C21.6 2 22 2.4 22 3V11C22 11.6 21.6 12 21 12C20.4 12 20 11.6 20 11V5ZM4 19C4 19.6 4.4 20 5 20H11C11.6 20 12 20.4 12 21C12 21.6 11.6 22 11 22H3C2.4 22 2 21.6 2 21V13C2 12.4 2.4 12 3 12C3.6 12 4 12.4 4 13V19Z"></path></svg>
    </span>
</bslib-tooltip><script data-bslib-card-init="">bslib.Card.initializeAllCards();</script></div>
</div>
<div class="html-fill-item html-fill-container bslib-grid" style="display: grid; grid-template-columns: minmax(3em, 1fr);
grid-auto-rows: minmax(0, 1fr);">
<div class="card html-fill-item html-fill-container bslib-card" data-title="VARIABLES" data-fill="false" data-bslib-card-init="" data-require-bs-caller="card()" data-full-screen="false">
<div class="card-header"><div class="card-title html-fill-item html-fill-container"><span style="display: inline">
VARIABLES
</span></div></div>
<div class="card-body html-fill-item html-fill-container">
<table class="caption-top table">
<thead>
<tr class="header">
<th>Variable</th>
<th>Notes - <a href="https://www150.statcan.gc.ca/n1/pub/71-543-g/71-543-g2020001-eng.htm">Source: Guide to the Labour Force</a></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Sector</td>
<td><ul>
<li><p>Does the employee work in the public or private sector?</p></li>
<li><p>The <strong>public sector</strong> includes employees in federal, provincial, territorial, municipal and Aboriginal public administrations, as well as in Crown corporations, liquor control boards and other government institutions such as schools (including universities), hospitals and public libraries.</p></li>
<li><p>The <strong>private sector</strong> comprises all other employees that are not in the public sector, including paid employees, as well as self-employed people and unpaid family workers (not included in this report).</p></li>
</ul></td>
</tr>
<tr class="even">
<td>Province</td>
<td><ul>
<li>Province of residence at time of survey</li>
<li>Territories are not included in the LFS data</li>
</ul></td>
</tr>
<tr class="odd">
<td>CMA</td>
<td><ul>
<li><a href="https://www150.statcan.gc.ca/n1/pub/92-195-x/2021001/geo/cma-rmr/cma-rmr-eng.htm">Census Metropolitan Area</a> of residence at time of survey</li>
<li>Includes the 9 largest CMAs vs.&nbsp;All other CMAs/Non-CMA areas</li>
</ul></td>
</tr>
<tr class="even">
<td>Age group</td>
<td><ul>
<li>Age of respondent (4 groups)</li>
<li>Data is collected from people ages 15 and up</li>
</ul></td>
</tr>
<tr class="odd">
<td>Gender</td>
<td><ul>
<li><p>Gender of respondent</p></li>
<li><p>Data on more diverse gender identities isn’t available at this time</p></li>
</ul></td>
</tr>
<tr class="even">
<td>Family type</td>
<td><ul>
<li>Family type of respondent</li>
<li>The LFS uses the <a href="https://www23.statcan.gc.ca/imdb/p3Var.pl?Function=Unit&amp;Id=33863">economic family concept</a> to categorize family arrangements</li>
</ul></td>
</tr>
<tr class="odd">
<td>Youngest child</td>
<td><ul>
<li>Age of respondent’s youngest child (if any) in years, 1-24 years old</li>
</ul></td>
</tr>
<tr class="even">
<td>Education level</td>
<td><ul>
<li>Highest education level attained by respondent</li>
</ul></td>
</tr>
<tr class="odd">
<td>Student status</td>
<td><ul>
<li>Student Status of respondent</li>
<li>Whether the respondent is attending an educational program during the reference week, regardless of the level of that program</li>
</ul></td>
</tr>
<tr class="even">
<td>Immigration</td>
<td><ul>
<li>Whether the respondent was born in Canada or immigrated to Canada</li>
<li>People that have been landed immigrants or permanent residents of Canada are counted as immigrants, regardless of citizenship status</li>
</ul></td>
</tr>
<tr class="odd">
<td>Occupation</td>
<td><ul>
<li>Occupation of respondent</li>
<li>Based on type of work performed by respondent during the reference week</li>
<li>10 categories based on the National Occupational Classification System (<a href="https://noc.esdc.gc.ca/">NOCS</a>) 2021 version</li>
<li><em>Note</em>: some series are missing entirely, as there are too few of certain occupation types in a sector to produce usable values (<em>e.g.</em> public administration workers in the private sector)</li>
</ul></td>
</tr>
<tr class="even">
<td>Industry</td>
<td><ul>
<li>Industry of employment of respondent</li>
<li>Based on general nature of business carried out in the establishment of work</li>
<li>21 categories based on the National Industry Classification System (<a href="https://www23.statcan.gc.ca/imdb/p3VD.pl?Function=getVD&amp;TVD=1181553">NAICS</a>) 2021 version</li>
<li><em>Note</em>: some series are missing entirely, as there is too little employment in an industry to produce usable values (<em>e.g.</em> manufacturing employment the public sector)</li>
</ul></td>
</tr>
<tr class="odd">
<td>Establishment size</td>
<td><ul>
<li><p>Size of the establishment the respondent works in</p></li>
<li><p>Establishment size refers to the number employees at the location of employment (<em>e.g.</em> a building or compound)</p></li>
</ul></td>
</tr>
<tr class="even">
<td>Firm size</td>
<td><ul>
<li><p>Size of the firm the respondent works in.</p></li>
<li><p>Firm size refers to the number of employees that work at all locations of a given business/organizational entity (<em>e.g.</em> a corporation or non-profit)</p></li>
</ul></td>
</tr>
<tr class="odd">
<td>Employment size</td>
<td><ul>
<li><p>Employment status markers</p></li>
<li><p>Standard/Non-standard employment</p>
<ul>
<li><p>NSE: employees in any combination of the following, part-time, temporary, multiple-jobholders, precarious self-employed (not included)</p></li>
<li><p>Standard: The absence of any of the NSE markers above.</p></li>
<li><p>More information on <a href="https://www.erudit.org/en/journals/ri/2022-v77-n1-ri06959/1088554ar/">how NSE was categorized using method in source.</a></p></li>
</ul></li>
<li>Full-time/Part-time
<ul>
<li><p>Full time: usually works 30 hours per week at main/only job</p></li>
<li><p>Part-time: usually works under 30 hours at main/only job</p></li>
</ul></li>
<li>Permanent/Temporary
<ul>
<li><p>Permanent: Expected to last as long as the employee wants it, business conditions permitting; no pre-determined contract end date.</p></li>
<li><p>Temporary: Expected to end at a pre-determined date or after the completion of a particular project; seasonal, temporary, term-based or contract employees.</p></li>
</ul></li>
<li><p>Single/Multiple job holders</p>
<ul>
<li>Multiple job holders worked at two or more jobs during the reference week.</li>
</ul></li>
<li><p>Proportions add up to 100% for each sub-group by sector, counts add up to the total number of employees in each sub-group.</p></li>
</ul></td>
</tr>
<tr class="even">
<td>Job tenure</td>
<td><ul>
<li>Respondent’s job tenure in years, under one to ten+ years</li>
<li>Number of consecutive months or years respondent has worked for the same employer</li>
<li><a href="https://www150.statcan.gc.ca/n1/pub/14-28-0001/2024001/article/00007-eng.htm">Source of tenure categories here</a></li>
</ul></td>
</tr>
</tbody>
</table>
</div>
<bslib-tooltip placement="auto" bsoptions="[]" data-require-bs-version="5" data-require-bs-caller="tooltip()">
    <template>Expand</template>
    <span class="bslib-full-screen-enter badge rounded-pill">
        <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" style="height:1em;width:1em;" aria-hidden="true" role="img"><path d="M20 5C20 4.4 19.6 4 19 4H13C12.4 4 12 3.6 12 3C12 2.4 12.4 2 13 2H21C21.6 2 22 2.4 22 3V11C22 11.6 21.6 12 21 12C20.4 12 20 11.6 20 11V5ZM4 19C4 19.6 4.4 20 5 20H11C11.6 20 12 20.4 12 21C12 21.6 11.6 22 11 22H3C2.4 22 2 21.6 2 21V13C2 12.4 2.4 12 3 12C3.6 12 4 12.4 4 13V19Z"></path></svg>
    </span>
</bslib-tooltip><script data-bslib-card-init="">bslib.Card.initializeAllCards();</script></div>
</div>
<div class="html-fill-item html-fill-container bslib-grid" style="display: grid; grid-template-columns: minmax(3em, 1fr);
grid-auto-rows: minmax(0, 1fr);">
<div class="card html-fill-item html-fill-container bslib-card" data-title="MEASURES AND LAYOUTS" data-fill="false" data-bslib-card-init="" data-require-bs-caller="card()" data-full-screen="false">
<div class="card-header"><div class="card-title html-fill-item html-fill-container"><span style="display: inline">
MEASURES AND LAYOUTS
</span></div></div>
<div class="card-body html-fill-item html-fill-container">
<table class="caption-top table">
<colgroup>
<col style="width: 16%">
<col style="width: 83%">
</colgroup>
<thead>
<tr class="header">
<th>Measure</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Union density</td>
<td><ul>
<li><p>The percentage of employees that are union members.</p></li>
<li><p>Includes paid employees only, so nobody reporting self-employment.</p></li>
</ul></td>
</tr>
<tr class="even">
<td>Distribution (%)</td>
<td><ul>
<li><p>The percentage of union members that belong to a given group, province, occupation, etc.</p></li>
<li><p>All groups add up to roughly 100%, may not be exact due to rounding.</p></li>
</ul></td>
</tr>
<tr class="odd">
<td>Distribution (N)</td>
<td><ul>
<li><p>The number of union members that belong to a given group, province, occupation, etc.</p></li>
<li><p>All groups adds up to the total number of union members.</p></li>
</ul></td>
</tr>
</tbody>
</table>
<table class="caption-top table">
<colgroup>
<col style="width: 9%">
<col style="width: 90%">
</colgroup>
<thead>
<tr class="header">
<th>Layout</th>
<th>Useful for</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Vertical</td>
<td><ul>
<li><p>Making comparisons between the public and private sector by variable level.</p></li>
<li><p><em>Ex:</em> Comparing union density over time in each province in the private sector versus the public sector.</p></li>
</ul></td>
</tr>
<tr class="even">
<td>Horizontal</td>
<td><ul>
<li><p>Making comparisons between variable levels within the public and private sectors.</p></li>
<li><p><em>Ex:</em> Comparing the union density trend over time in the private sector from one education level to the next.</p></li>
</ul></td>
</tr>
<tr class="odd">
<td>Stacked</td>
<td><ul>
<li><p>Seeing how the groups indicated by variable levels form parts of the whole in each sector.</p></li>
<li><p><em>Ex:</em> Observing how the age composition of total union membership has changed over time in the private and public sectors.</p></li>
</ul></td>
</tr>
</tbody>
</table>
</div>
<bslib-tooltip placement="auto" bsoptions="[]" data-require-bs-version="5" data-require-bs-caller="tooltip()">
    <template>Expand</template>
    <span class="bslib-full-screen-enter badge rounded-pill">
        <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" style="height:1em;width:1em;" aria-hidden="true" role="img"><path d="M20 5C20 4.4 19.6 4 19 4H13C12.4 4 12 3.6 12 3C12 2.4 12.4 2 13 2H21C21.6 2 22 2.4 22 3V11C22 11.6 21.6 12 21 12C20.4 12 20 11.6 20 11V5ZM4 19C4 19.6 4.4 20 5 20H11C11.6 20 12 20.4 12 21C12 21.6 11.6 22 11 22H3C2.4 22 2 21.6 2 21V13C2 12.4 2.4 12 3 12C3.6 12 4 12.4 4 13V19Z"></path></svg>
    </span>
</bslib-tooltip><script data-bslib-card-init="">bslib.Card.initializeAllCards();</script></div>
</div>
</div>
</div>
<div id="charts" class="dashboard-page tab-pane grid-skip html-fill-item html-fill-container" data-orientation="rows" aria-labelledby="tab-charts">
<div class="html-fill-item html-fill-container bslib-grid" style="display: grid; grid-template-rows: minmax(3em, max-content); grid-auto-columns: minmax(0, 1fr);">
<div class="html-fill-item html-fill-container bslib-grid" style="display: grid; grid-template-columns: minmax(3em, 1fr);
grid-auto-rows: minmax(0, 1fr);">
<div class="card cell html-fill-item html-fill-container bslib-card" data-fill="false" data-bslib-card-init="" data-require-bs-caller="card()" data-full-screen="false">
<div class="card-body html-fill-item html-fill-container">
<div class="cell-output-display html-fill-item html-fill-container">
<div class="shiny-plot-output html-fill-item html-fill-container" id="plot" style="width:auto;height:100%;"></div>
</div>
</div>
<bslib-tooltip placement="auto" bsoptions="[]" data-require-bs-version="5" data-require-bs-caller="tooltip()">
    <template>Expand</template>
    <span class="bslib-full-screen-enter badge rounded-pill">
        <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" style="height:1em;width:1em;" aria-hidden="true" role="img"><path d="M20 5C20 4.4 19.6 4 19 4H13C12.4 4 12 3.6 12 3C12 2.4 12.4 2 13 2H21C21.6 2 22 2.4 22 3V11C22 11.6 21.6 12 21 12C20.4 12 20 11.6 20 11V5ZM4 19C4 19.6 4.4 20 5 20H11C11.6 20 12 20.4 12 21C12 21.6 11.6 22 11 22H3C2.4 22 2 21.6 2 21V13C2 12.4 2.4 12 3 12C3.6 12 4 12.4 4 13V19Z"></path></svg>
    </span>
</bslib-tooltip><script data-bslib-card-init="">bslib.Card.initializeAllCards();</script></div>
</div>
</div>
</div>
<div id="table" class="dashboard-page tab-pane grid-skip html-fill-item html-fill-container" data-orientation="rows" aria-labelledby="tab-table">
<div class="html-fill-item html-fill-container bslib-grid" style="display: grid; grid-template-rows: minmax(3em, max-content); grid-auto-columns: minmax(0, 1fr);">
<div class="html-fill-item html-fill-container bslib-grid" style="display: grid; grid-template-columns: minmax(3em, 1fr);
grid-auto-rows: minmax(0, 1fr);">
<div class="card cell html-fill-item html-fill-container bslib-card" data-fill="false" data-bslib-card-init="" data-require-bs-caller="card()" data-full-screen="false">
<div class="card-body html-fill-item html-fill-container">
<div class="cell-output-display html-fill-item html-fill-container no-overflow-x">
<div id="table_title" class="shiny-html-output html-fill-item html-fill-container"></div>
</div>
<div class="cell-output-display html-fill-item html-fill-container no-overflow-x">
<div id="table" class="shiny-html-output html-fill-item html-fill-container"></div>
</div>
</div>
<bslib-tooltip placement="auto" bsoptions="[]" data-require-bs-version="5" data-require-bs-caller="tooltip()">
    <template>Expand</template>
    <span class="bslib-full-screen-enter badge rounded-pill">
        <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" style="height:1em;width:1em;" aria-hidden="true" role="img"><path d="M20 5C20 4.4 19.6 4 19 4H13C12.4 4 12 3.6 12 3C12 2.4 12.4 2 13 2H21C21.6 2 22 2.4 22 3V11C22 11.6 21.6 12 21 12C20.4 12 20 11.6 20 11V5ZM4 19C4 19.6 4.4 20 5 20H11C11.6 20 12 20.4 12 21C12 21.6 11.6 22 11 22H3C2.4 22 2 21.6 2 21V13C2 12.4 2.4 12 3 12C3.6 12 4 12.4 4 13V19Z"></path></svg>
    </span>
</bslib-tooltip><script data-bslib-card-init="">bslib.Card.initializeAllCards();</script></div>
</div>
</div>
</div>
<div id="data" class="dashboard-page tab-pane grid-skip html-fill-item html-fill-container dashboard-sidebar-container" data-orientation="rows" aria-labelledby="tab-data">
<div class="bslib-sidebar-layout html-fill-item html-fill-container" data-bslib-sidebar-open="desktop" data-bslib-sidebar-init="true" data-bslib-sidebar-border="false" data-bslib-sidebar-border-radius="false"><div class="main html-fill-container html-fill-item"><div class="sidebar-content html-fill-item html-fill-container">
<div class="html-fill-item html-fill-container bslib-grid" style="display: grid; grid-template-columns: minmax(3em, 1fr);
grid-auto-rows: minmax(0, 1fr);">
<div class="html-fill-item html-fill-container bslib-grid" style="display: grid; grid-template-rows: minmax(3em, 1fr); grid-auto-columns: minmax(0, 1fr);">
<div class="card cell html-fill-item html-fill-container bslib-card" data-bslib-card-init="" data-require-bs-caller="card()" data-full-screen="false">
<div class="card-body html-fill-item html-fill-container">
<div class="cell-output-display html-fill-item html-fill-container no-overflow-x">
<div id="data_preview" class="shiny-html-output html-fill-item html-fill-container"></div>
</div>
</div>
<bslib-tooltip placement="auto" bsoptions="[]" data-require-bs-version="5" data-require-bs-caller="tooltip()">
    <template>Expand</template>
    <span class="bslib-full-screen-enter badge rounded-pill">
        <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" style="height:1em;width:1em;" aria-hidden="true" role="img"><path d="M20 5C20 4.4 19.6 4 19 4H13C12.4 4 12 3.6 12 3C12 2.4 12.4 2 13 2H21C21.6 2 22 2.4 22 3V11C22 11.6 21.6 12 21 12C20.4 12 20 11.6 20 11V5ZM4 19C4 19.6 4.4 20 5 20H11C11.6 20 12 20.4 12 21C12 21.6 11.6 22 11 22H3C2.4 22 2 21.6 2 21V13C2 12.4 2.4 12 3 12C3.6 12 4 12.4 4 13V19Z"></path></svg>
    </span>
</bslib-tooltip><script data-bslib-card-init="">bslib.Card.initializeAllCards();</script></div>
<div id="3ade8a4a-fb1d-4a6c-8409-ac45482d5fc9" class="hidden html-fill-item html-fill-container">

</div>
</div>
</div>
</div></div><aside id="bslib-sidebar-1" class="sidebar html-fill-container html-fill-item"><div class="html-fill-item html-fill-container">
<p>Click the download button to retrieve a CSV (comma-separated value) file containing the chart data in long format.</p>
<p><strong>Columns</strong></p>
<p>Union density</p>
<ul>
<li><p>pop = number of paid employees</p></li>
<li><p>p_in_union = % employees that are union members/not members by varlevel (Proportion)</p></li>
<li><p>p_population = employees as a % of the total workforce by varlevel (Proportion)</p></li>
</ul>
<p>Distribution</p>
<ul>
<li><p>members = number of union members by varlevel</p></li>
<li><p>p_members = % members that belong to varlevel (Proportion)</p></li>
</ul>
<div class="cell-output-display">
<a id="data" class="btn btn-default shiny-download-link disabled" href="" target="_blank" download="" aria-disabled="true" tabindex="-1">
<i class="fas fa-download" role="presentation" aria-label="download icon"></i>
Download
</a>
</div>
</div></aside>
<button class="collapse-toggle" type="button" title="Toggle sidebar" aria-expanded="true" aria-controls="bslib-sidebar-1">
    <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 16 16" class="bi bi-chevron-left collapse-icon" style="fill:currentColor;" aria-hidden="true" role="img">
      <path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"></path>
    </svg>
</button>
<script data-bslib-sidebar-init="">
bslib.Sidebar.initCollapsibleAll()
</script>
</div>
</div>
</div>
</div></div>
<p>
<script type="application/shiny-prerendered" data-context="server-start">
# Libraries, fonts themes
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, dev = "svg")
xfun::pkg_attach("tidyverse", "targets", "here", "scales", "qs", "zoo", "patchwork", "shiny", "shinyjs", "rlang", "ggrepel", "ggtext", "ggfittext", "kableExtra", "glue", "targets")

dashpal <-  c("#771155", "#117777")
rpal <- c("#771155", "#AA4488", "#CC99BB", 
          "#114477", "#4477AA", "#77AADD", 
          "#117777", "#44AAAA", "#77CCCC", 
          "#117744", "#44AA77", "#88CCAA", 
          "#777711", "#AAAA44", "#DDDD77", 
          "#774411", "#AA7744", "#DDAA77", 
          "#771122", "#AA4455", "#DD7788")

dens_pal <- list(c(`Union member` = dashpal[2], `Not member` = "#DADDEF"),
                      c(`Union member` = dashpal[1], `Not member` = "#DADDEF"))
bar_pal <- list(
  c(`yes` = dashpal[2], `no` = "#DADDEF"),  # private
  c(`yes` = dashpal[1], `no` = "#DADDEF")  # public
)

theme_rr_dash <-
  function(base_size = 14, legend = 'none') {
    theme_minimal() %+replace%
      theme(
        text = element_text(size = 6),
        axis.text.y = element_text(size = 16),
        axis.text.x = element_text(size = 16),
        axis.title = element_text(size = 14),
        plot.title = element_text(
          size = 20,
          hjust = 0,
          face = 'bold',
          margin = margin(b = 6)
        ),
        plot.subtitle = element_text(
          size = 18,
          hjust = 0,
          margin = margin(b = 10)
        ),
        plot.title.position = 'plot',
        plot.caption = element_text(
          size = 12,
          face = 'italic',
          hjust = 1,
          margin = margin(t = 10)
        ),
        panel.grid.minor = element_blank(),
        legend.position = legend,
        strip.text = element_text(
          size = 18,
          face = "bold",
          color = "#353935",
          hjust = 0,
          margin = margin(b = 5, unit = "mm")
        )
      )
  }
</script>
 
<script type="application/shiny-prerendered" data-context="data">
# Data import and prep
## Density data
dens_df <- tar_read(density_df) |> 
  mutate(p = ifelse(is.nan(p), NA, p))

## Distribution data
pop_df <- tar_read(dist_df)

# Dataframe full of default factor levels
factor_levels <-
  tribble(
    ~ varlevel,
    ~ variable,
    
    # Age groups
    "65+","Age group",
    "55 to 64","Age group",
    "25 to 54","Age group",
    "15 to 24","Age group",
    
    # CMA
    "Calgary","CMA",
    "Edmonton","CMA",
    "Hamilton","CMA",
    "Montréal","CMA",
    "Ottawa–Gatineau","CMA",
    "Québec","CMA",
    "Toronto","CMA",
    "Vancouver","CMA",
    "Winnipeg","CMA",
    "Other CMA/non-CMA","CMA",
    
    # Province
    "Alberta","Province",
    "British Columbia","Province",
    "Manitoba","Province",
    "New Brunswick","Province",
    "Newfoundland","Province",
    "Nova Scotia","Province",
    "Ontario","Province",
    "PEI","Province",
    "Quebec","Province",
    "Saskatchewan","Province",
    
    # Education
    "Graduate","Education level",
    "Undergraduate","Education level",
    "College","Education level",
    "Secondary/Some PSE","Education level",
    "Under secondary","Education level",
    
    # Student status
    "Part-time student","Student status",
    "Full-time student","Student status",
    "Non-student","Student status",
    
    # Family type
    "Other families","Family type",
    "Lone-parent","Family type",
    "Not in econ family","Family type",
    "Single-earner","Family type",
    "Dual-earner","Family type",
    
    # Gender
    "Men","Gender",
    "Women","Gender",
    
    # Immigration
    "Immigrant < 10 years","Immigration",
    "Immigrant > 10 years","Immigration",
    "Non-immigrant","Immigration",
    
    # Employment
    "Standard employment","Employment status",
    "Non-standard employment","Employment status",
    "Full-time","Employment status",
    "Part-time","Employment status",
    "Multiple jobholder","Employment status",
    "Single jobholder","Employment status",
    "Permanent","Employment status",
    "Temporary, casual","Employment status",
    "Temporary, seasonal","Employment status",
    "Temporary, term/contract","Employment status",
    
    # Job tenure
    "10 years or more","Job tenure",
    "5 to under 10","Job tenure",
    "1 to under 5","Job tenure",
    "Under 1 year","Job tenure",
    
    # Industry
    "Accomodation/Food","Industry",
    "Agriculture","Industry",
    "Business/Building/Other services","Industry",
    "Construction","Industry",
    "Education","Industry",
    "Finance/Insurance","Industry",
    "Fishing/Hunting/Trapping","Industry",
    "Forestry/Support activities","Industry",
    "Health care/Social assistance","Industry",
    "Information/Culture/Recreation","Industry",
    "Manufacturing, durable","Industry",
    "Manufacturing, non-durable","Industry",
    "Mining/Quarrying/Oil and gas","Industry",
    "Other services","Industry",
    "Professional/Scientific/Technical","Industry",
    "Public administration","Industry",
    "Real estate/Rental/Leasing","Industry",
    "Retail trade","Industry",
    "Transportation/Warehousing","Industry",
    "Utilities","Industry",
    "Wholesale trade","Industry",
    
    # Firm size
    "More than 500 employees", "Firm size",
    "100 to 500 employees","Firm size",
    "20 to 99 employees","Firm size",
    "Less than 20 employees","Firm size",
    
    # Est size
    "More than 500 employees","Establishment size",
    "100 to 500 employees","Establishment size",
    "20 to 99 employees","Establishment size",
    "Less than 20 employees","Establishment size",
    
    # Occupation
    "Business/Finance/Admin","Occupation",
    "Health","Occupation",
    "Management","Occupation",
    "Natural/Applied sciences","Occupation",
    "Natural resources/Agriculture/Related","Occupation",
    "Art/Culture/Recreation/Sport","Occupation",
    "Education/Law/SCG services","Occupation",
    "Manufacturing/Utilities","Occupation",
    "Sales/Service","Occupation",
    "Trades/Transport/Equip operators","Occupation",

    # Youngest child
    "18-24 years","Youngest child",
    "13-17 years","Youngest child",
    "6-12 years","Youngest child",
    "Under 6 years","Youngest child",
    "No children","Youngest child"
)

# Pull main variables for selector list
dash_vars <- dens_df |> distinct(variable) |> pull() |> as.character()

# Set selector list order
dash_vars_order <- c(
  "Province",
  "CMA",
  "Age group",
  "Gender",
  "Family type",
  "Youngest child",
  "Education level",
  "Student status",
  "Immigration",
  "Occupation",
  "Industry",
  "Establishment size",
  "Firm size",
  "Employment status",
  "Job tenure")
dash_vars <- dash_vars[order(match(dash_vars, dash_vars_order))]
</script>
 
<script type="application/shiny-prerendered" data-context="server">
##### Dynamic UI
observe({
    if (input$gg_layout == "Stacked" & 
        input$measure %in% c(
          "Distribution (%)", "Distribution (N)"
        )) {
      shinyjs::show("ordering")
    } else {
      shinyjs::hide("ordering")
    }
  })
  
##### DATA
# Default factor levels
flevels <- reactive({
  req(input$variable)
  factor_levels[factor_levels$variable == input$variable, ] |> 
    pull(varlevel) |> as.character()
})

# Create union density data set, reactive
dataset <- reactive({
  req(input$variable)
  df <- dens_df[dens_df$variable == input$variable, ] |> 
    mutate(varlevel = factor(varlevel, levels = flevels()))
})

# Create demographic dataset, reactive
dataset_pop <- reactive({
  req(input$variable)
  df <- pop_df[pop_df$variable == input$variable, ] |>
    mutate(varlevel = factor(varlevel, levels = flevels())) |>
    group_by(survyear, variable, var_orig, cowmain_rc) |>
    mutate(
      p_memb = n / sum(n),
      # Calculate the bar/area backdrop
      p_memb_bd = 1 - p_memb,
      cowmain_rc = as_factor(as.character(cowmain_rc))
      ) |> 
    ungroup()
})

# Calculate population totals per variable level
pop_totals <- reactive({dataset_pop() |> 
  filter(survyear==2024) |> 
  group_by(survyear, var_orig, varlevel) |> 
  reframe(n = sum(n), p_memb = sum(p_memb)) |> 
  arrange(-n)
})

# Create character vector for default factor ordering
pop_levels <- reactive({pop_totals() |> 
  pull(varlevel) |> 
  as.character()
})

# Create reactive data set for Kable table
kbl_df <- reactive({
  if (input$measure == "Union density") {
    kb_prep(dataset())
  } else if (input$measure %in% c("Distribution (%)", "Distribution (N)")) {
    kb_prep(dataset_pop())
  }
})
</script>
 
<script type="application/shiny-prerendered" data-context="server">
##### HELPER

# Programmatic chart and output height
n_facets <- function() {
  # All vertical and horizontal charts
  if (input$gg_layout %in% c("Vertical", "Horizontal")) {
    return (500 * (distinct(dataset(), varlevel) |> nrow() /  2))
    # Stacked charts for demographics
  } else if (input$gg_layout == "Stacked" &
             input$variable != "Employment status" &
             input$measure != "Union density") {
    return(650)
  } else if (input$gg_layout == "Stacked" &
           input$variable == "Employment status" &
           input$measure != "Union density") {
    return(1200)
  } else if (input$gg_layout == "Stacked" &
           input$measure == "Union density") {
    return (500 * (distinct(dataset(), varlevel) |> nrow() /  2))
  }
}

# Number of facets desired by variable
num_rows <- reactive(
  case_when(
    input$variable %in% c("Gender","Immigration","Age group","Student status") ~ 1,
    input$variable %in% c(
      "Education level",
      "Family type",
      "Youngest child",
      "Job tenure",
      "Firm size",
      "Establishment size"
    ) ~ 2,
    input$variable %in%
      c(
        "Province",
        "CMA",
        "Occupation",
        "Employment status"
      ) ~ 4,
    input$variable %in% c("Industry") ~ 7
  )
)

# Area margins desired by variable
area_margins <- reactive(
  case_when(
    input$variable %in% c("Gender") ~ 75,
    input$variable %in% c(
      "Job tenure",
      "Age group",
      "Family type",
      "Youngest child",
      "Student status"
    ) ~ 130,
    input$variable %in%
      c("Province", "CMA","Education level","Immigration","Employment status", "Firm size", "Establishment size") ~ 150,
    input$variable %in% c("Industry", "Occupation") ~ 270
  )
)

## Table helpers
# Kable table prep
kb_prep <- function(df) {
  
  variable <- df |> distinct(variable) |> pull(variable) |> as.character()
  
  if (input$measure == "Union density") {
    df <- df |>
      filter(union_bin == "Union member") |> 
      select(survyear, cowmain_rc, varlevel, value = p) |> 
      pivot_wider(
        id_cols = c(survyear, cowmain_rc),
        names_from = varlevel,
        values_fn = \(x) cell_spec(formattable::percent(x, digits = 1))
      ) 
    
  } else if (input$measure == "Distribution (%)") {
    df <- df |>
      select(survyear, cowmain_rc, varlevel, value = p_memb) |> 
      pivot_wider(
        id_cols = c(survyear, cowmain_rc),
        names_from = varlevel,
        values_fn = \(x) cell_spec(formattable::percent(x, digits = 1))
      ) 
  }
  
  else if (input$measure == "Distribution (N)") {
    df <- df |>
      select(survyear, cowmain_rc, varlevel, value = n) |> 
      pivot_wider(
        id_cols = c(survyear, cowmain_rc),
        names_from = varlevel,
        values_fn = \(x) cell_spec(formattable::comma(x/1000, digits = 0)) 
      ) 
  }
  
  if (input$variable %in% c("Industry", "Occupation")) {
    df |> 
      pivot_longer(3:last_col()) |> 
      pivot_wider(names_from = 1) |> 
      arrange(cowmain_rc) 

  } else {
    df |> 
      arrange(cowmain_rc) 
  }
}

# Plot top label
plot_title <- reactive({
  if (input$measure == "Union density") {
    "<span style='font-size:18px'><b>Union density<\u002fb><\u002fspan>"
  } else if (input$measure == "Distribution (%)") {
    "<span style='font-size:18px'><b>Membership distribution (%)/b><\u002fspan>"
  } else if (input$measure == "Distribution (N)") {
    "<span style='font-size:18px'><b>Membership distribution (N)<\u002fb><\u002fspan>"
  }
})

# Table subtitles
kb_title <- reactive({
  if (input$measure == "Union density") {
    "<span style='font-size:18px'><b>Union density (% of group that are Union members)<\u002fb><\u002fspan>"
  } else if (input$measure == "Distribution (%)") {
    "<span style='font-size:18px'><b>Distribution Union member by group<\u002fb><\u002fspan>"
  } else if (input$measure == "Distribution (N)") {
    "<span style='font-size:18px'><b>Number of union members in thousands<\u002fb><\u002fspan>"
  }
})
</script>
 
<script type="application/shiny-prerendered" data-context="server">
##### Base plot functions

# Union density (Vertical and Horizontal)
union_density_gg <- function(.data, pal) {
  
  # For ordering plots by average values of coverage
  if (input$gg_layout == "Horizontal") {
    horiz_levels <- filter(.data, union_bin == "Union member") |>
      group_by(varlevel) |>
      reframe(p = mean(p, na.rm = TRUE)) |>
      arrange(-p) |>
      pull(varlevel) |>
      as.character()

    .data <- mutate(.data, varlevel = factor(varlevel, levels = horiz_levels))
  }

  gg <- ggplot(
    .data,
    aes(
      x = .data$survyear,
      y = .data$p,
      fill = .data$union_bin,
      color = .data$union_bin
    )
  ) +
    geom_area(alpha = 0.55) +
    geom_point(data = filter(.data, union_bin == "Union member"),
               size = 2.25) +
    geom_hline(yintercept = 0, color = "#d8d8d8") +
    coord_cartesian(clip = "off") +
    scale_y_continuous(labels = label_percent(),
                       expand = c(0, 0)) +
    scale_fill_manual(values = pal, na.value = "#DADDEF") +
    scale_color_manual(values = pal, na.value = "#DADDEF") +
    theme_rr_dash() +
    theme(
      panel.grid = element_blank(),
      axis.text.y.left = element_blank(),
      panel.spacing.y = unit(15, "pt")
    ) +
    labs(x = NULL, y = NULL)
  
  # Vertical layout
  if (input$gg_layout == "Vertical") {
    gg +
      geom_text(
        data = filter(
          .data,
          union_bin == "Union member",
          survyear %in% seq(2006, 2024, by = 3)
        ),
        aes(label = percent(.data$p, accuracy = .1)),
        vjust = 0,
        hjust = 0.5,
        nudge_y = .04,
        fontface = "bold",
        size = 6
      ) +
      scale_x_continuous(
        expand = c(0.05, 0.05),
        breaks = seq(2006, 2024, by = 3),
        guide = guide_axis(check.overlap = TRUE)
      ) +
      facet_wrap(vars(varlevel),
                 ncol = 1,
                 dir = "v",
                 axes = "all_x")
    
    # Horizontal layout
  } else if (input$gg_layout == "Horizontal") {
    
    gg +
    geom_text_repel(
      data = filter(
        .data,
        union_bin == "Union member",
        survyear %in% seq(2006, 2024, by = 6)
      ),
      aes(label = percent(.data$p, accuracy = .1)),
      vjust = 0,
      #hjust = 0.42,
      hjust = 0.5,
      nudge_y = .04,
      #check_overlap = TRUE,
      size = 6,
      point.size = NA,
      min.segment.length = Inf,
      force = .25
    ) +
    theme(
      panel.spacing.x = unit(10, "pt"),
     # axis.text.x = element_markdown(hjust = c(0, 1)),
      strip.clip = "on"
    ) +
    scale_x_continuous(
      expand = c(0.05, 0.05),
      breaks = seq(2006, 2024, by = 6),
      guide = guide_axis(check.overlap = TRUE)
    ) +
    facet_wrap(
      vars(varlevel),
      nrow = num_rows(),
      dir = "h",
      axes = "all_x",
      drop = TRUE,
      labeller = label_wrap_gen(width = 30)
    )
  }
}

# Union density (Stacked, total workforce)
union_density_stacked_gg <- function(.data) {
  
  req(input$measure == "Union density")
  
  dens_pal_flat <- c(
    `Private (Unionized)` = dashpal[2],
    `Private (No union)` = colorspace::lighten(dashpal[2], .5),
    `Public (Unionized)` = dashpal[1],
    `Public (No union)` = colorspace::lighten(dashpal[1], .5)
  )
  
  .data <- mutate(.data, unioncow = fct_rev(unioncow))
  
  gg <- .data |>
    ggplot(
      aes(
        x = .data$survyear,
        y = .data$p_pop,
        fill = .data$unioncow,
      )
    ) +
    geom_area(
      aes(color = .data$unioncow),
      show.legend = c(fill = TRUE, color = NA)
    ) +
    geom_label(
      data = filter(.data, 
                    survyear %in% seq(2006,2024, by = 3),
                    p_pop >= .03),
      aes(
        label = percent(.data$p_pop, accuracy = .1),
        group = unioncow
      ),
      vjust = 0.5,
      hjust = 0.5,
      fontface = "bold",
      size = 6,
      position = "stack",
      color = "#fff",
      label.padding = unit(.01, "lines"),
      show.legend = FALSE
    ) +
    geom_hline(yintercept = 0, color = "#d8d8d8") +
    coord_cartesian(clip = "off") +
    scale_x_continuous(breaks = seq(2006, 2024, by = 3),
                       guide = guide_axis(check.overlap = TRUE)) +
    scale_y_continuous(labels = label_percent(),
                       expand = c(0, 0)) +
    
    scale_fill_manual(values = dens_pal_flat, na.value = "#DADDEF") +
    scale_color_manual(values = dens_pal_flat, na.value = "#DADDEF", guide = "none") +
    theme_rr_dash() +
    guides(fill = guide_legend(reverse = TRUE, title = NULL)
           ) +
    theme(
      legend.position = "top",
      legend.text = element_text(size = 18, face = 'bold'),
      legend.key.size = unit(22, 'pt'),
      panel.grid = element_blank(),
      axis.text.y.left = element_blank(),
      panel.spacing.y = unit(15, "pt")
    ) +
    labs(x = NULL, y = NULL, 
         subtitle = 
           glue("Union member share of workforce (paid employees) by {input$variable}")) +
    facet_wrap(vars(varlevel), ncol = 2, dir = "v", axes = "all_x")
}

# Demographics, bar charts
union_bars_gg <- function(.data, pal) {
  .data <- filter(.data, survyear %in% seq(2006, 2024, by = 3))
  
  # For ordering plots by average values horizontally - Proportions
  if (input$gg_layout == "Horizontal" &
      input$measure == "Distribution (%)") {
    horiz_levels <- group_by(.data, varlevel) |>
      reframe(p_memb = mean(p_memb)) |>
      arrange(-p_memb) |>
      pull(varlevel)
    
    .data <- mutate(.data, varlevel = factor(varlevel, levels = horiz_levels))
    
    # For ordering plots by average values horizontally - Counts
  } else if (input$gg_layout == "Horizontal" &
             input$measure == "Distribution (N)") {
    horiz_levels <- group_by(.data, varlevel) |>
      reframe(n = sum(n)) |>
      arrange(-n) |>
      pull(varlevel)
    
    .data <- mutate(.data, varlevel = factor(varlevel, levels = horiz_levels))
  }
  
  ##### FOR PROPORTIONS
  if (input$measure == "Distribution (%)") {
    .data <- select(.data,
                    survyear,
                    variable,
                    varlevel,
                    cowmain_rc,
                    p_memb,
                    p_memb_bd) |>
      pivot_longer(
        cols = p_memb:p_memb_bd,
        names_to = "fillvar",
        values_to = "p_memb"
      ) |>
      mutate(
        fillvar = ifelse(fillvar == "p_memb", "yes", "no"),
        fillvar = factor(fillvar, levels = c("no", "yes")))
    
    gg <- ggplot(
      .data,
      aes(
        x = .data$survyear,
        y = .data$p_memb,
        fill = .data$fillvar
      )
    ) +
      geom_col(position = "fill") +
      geom_hline(yintercept = 0, color = "#d8d8d8") +
      geom_bar_text(
        data = filter(.data, fillvar == "yes"),
        formatter = percent_format(accuracy = .1),
        fontface = "bold",
        outside = TRUE,
        contrast = TRUE,
        size = 16,
        min.size = 12
      ) +
      scale_y_continuous(labels = percent_format(accuracy = 1L)) +
      scale_fill_manual(values = pal, na.value = "#DADDEF") +
      theme_rr_dash() +
      theme(panel.grid = element_blank()) +
      labs(x = NULL, y = NULL)
    
    ##### FOR COUNTS
  } else if (input$measure == "Distribution (N)") {
    gg <- ggplot(.data,
                 aes(
                   x = .data$survyear,
                   y = .data$n,
                   fill = .data$cowmain_rc,
                 )) +
      geom_col() +
      geom_hline(yintercept = 0, color = "#d8d8d8", linewidth = 1.45) +
      geom_bar_text(
        formatter = number_format(accuracy = .1, scale_cut = cut_short_scale()),
        fontface = "bold",
        outside = TRUE,
        contrast = TRUE,
        size = 15,
        min.size = 12
      ) +
      scale_y_continuous(expand = expansion(mult = c(0,.1))) +
      scale_fill_manual(values = c(`Public sector` = dashpal[1], `Private sector` = dashpal[2])) +
      theme_rr_dash() +
      theme(panel.grid = element_blank(), axis.text.y = element_blank(),
            panel.background = element_rect(fill = '#fafafa', colour = '#d9d9d9')) +
      labs(x = NULL, y = NULL)
  }
  
  ##### VERTICAL LAYOUT
  if (input$gg_layout == "Vertical") {
    gg +
      scale_x_continuous(
        expand = c(0.05, 0.05),
        breaks = seq(2006, 2024, by = 3),
        guide = guide_axis(check.overlap = TRUE)
      ) +
      theme(axis.text.y = element_blank(),
            panel.spacing.y = unit(15, "pt")) +
      facet_wrap(vars(varlevel),
                 ncol = 1,
                 dir = "v",
                 drop = FALSE,
                 axes = "all_x") 
    
    ##### HORIZONTAL LAYOUT
  } else if (input$gg_layout == "Horizontal") {
    gg + scale_x_continuous(
      expand = c(0.05, 0.05),
      breaks = seq(2006, 2024, by = 3),
      guide = guide_axis(check.overlap = TRUE)
    ) +
      facet_wrap(
        vars(fct_reorder(varlevel, p_memb, na.rm = TRUE)),
        nrow = num_rows(),
        dir = "h",
        axes = "all_x",
        drop = TRUE,
        labeller = label_wrap_gen(width = 30)
      ) +
      theme(panel.spacing.x = unit(10, "pt"),
            panel.spacing.y = unit(15, "pt"),
            strip.clip = "on")
  }
}

## Patchwork functions
# Create two charts per sector, patchwork into one chart
union_density_patch <- function(df, pal) {
  
  if (input$gg_layout %in% c("Vertical", "Horizontal")) {
    ggs <- group_by(df, cowmain_rc) |>
      group_split() |>
      map2(pal, \(x, y) union_density_gg(x, y))
    
    ggs[[1]] <- ggs[[1]] +
      ggtitle("PRIVATE SECTOR", subtitle = "Share of paid employees that are union members") +
      theme(plot.title = element_text(color = dashpal[2]))
    
    ggs[[2]] <- ggs[[2]] +
      ggtitle("PUBLIC SECTOR", subtitle = "Share of paid employees that are union members") +
      theme(plot.title = element_text(color = dashpal[1]))
    
    if (input$gg_layout == "Vertical") {
      ggs[[1]] + ggs[[2]]
    } else if (input$gg_layout == "Horizontal") {
      ggs[[1]] / ggs[[2]]
    }
  } else if (input$gg_layout == "Stacked") {
    union_density_stacked_gg(df)
  }
}

# Bar chart patchwork by sector function
union_bars_patch <- function(df, pal) {
  
  facet_blank <- function(str) {str_replace_all(str, ".", "")}
  
  subtitle <- case_when(
    input$measure == "Distribution (%)" ~ glue("Share of total union members by {input$variable}"),
    input$measure == "Distribution (N)" ~ glue("Number of union members by {input$variable}")
  )
  
  ggs <- group_by(df, cowmain_rc) |> 
    group_split() |> 
    map2(pal, \(x,y) union_bars_gg(x, y))
  
  ggs[[1]] <- ggs[[1]] + 
    ggtitle("PRIVATE SECTOR", subtitle = subtitle) +
    theme(plot.title = element_text(color = dashpal[2]))
  
  ggs[[2]] <- ggs[[2]] + 
    ggtitle("PUBLIC SECTOR", subtitle = subtitle) +
    theme(plot.title = element_text(color = dashpal[1]))
  
  if(input$gg_layout == "Vertical") {
    ggs[[1]] + ggs[[2]]
    
  } else if (input$gg_layout == "Horizontal") {
    ggs[[1]] / ggs[[2]]
    
  }
}

# Stacked area chart for stacked format
union_area_gg <- function(.data) {
  
  if(input$gg_layout == "Stacked" & 
      input$ordering == "Descending") {
   .data <- mutate(.data, varlevel = fct_reorder(varlevel, p_memb, na.rm = TRUE))
  }
  
  if (input$gg_layout == "Stacked" & input$measure == "Distribution (%)") {
  gg <- ggplot(.data, aes(.data$survyear, .data$p_memb, fill = .data$varlevel))
  
  } else if (input$gg_layout == "Stacked" & input$measure == "Distribution (N)") {
  gg <- ggplot(.data, aes(.data$survyear, .data$n, fill = .data$varlevel))
  
  }
  
  gg <- gg +
    geom_area(color = "#fff") +
    geom_label_repel(
      data = filter(.data, survyear == 2024, p_memb >= .01),
      aes(
        label = .data$varlevel,
        color = after_scale(prismatic::best_contrast(fill, c("white", "black")))
      ),
      position = ggpp::position_stacknudge(x = .5, vjust = 0.35),
      size = 5,
      fontface = "bold",
      force = 0.05,
      force_pull = 0.05,
      point.padding = .02,
      label.padding = .2,
      hjust = 0,
      seed = 2024,
      direction = "y",
      xlim = c(2024, 2150),
      min.segment.length = 0.35
    ) +
    geom_hline(yintercept = 0) +
    coord_cartesian(clip = "off") +
    scale_x_continuous(breaks = seq(2006, 2024, by = 6), expand = c(0,0)) +
    scale_fill_manual(values = rpal) +
    theme_rr_dash() +
    theme(
      panel.grid.major.x = element_blank(),
      panel.spacing.x = unit(area_margins(), "pt"),
      plot.margin = margin(r = unit(area_margins(), "pt"))
    ) +
    facet_wrap(vars(cowmain_rc)) +
    labs(x = NULL, y = NULL)
  
  if (input$measure == "Distribution (%)") {
    gg<- gg + labs(
      subtitle = glue("Distribution of union members by {input$variable}")) +
          scale_y_continuous(
            labels = label_percent(accuracy = 1L), expand = c(0, 0))
    
  } else if (input$measure == "Distribution (N)") {
    gg <- gg + labs(subtitle = glue("Number of union members by {input$variable}")) +
      scale_y_continuous(
        labels = label_number(accuracy = .1, scale_cut = cut_short_scale()), expand = c(0, 0))
  }
  
  if (input$variable == "Employment status") {
    gg + facet_wrap(vars(var_orig, cowmain_rc), ncol = 2)
  } else
  gg
}

# Table function
union_kbl <- function(df) {

kb_rows <- df |> 
  rownames_to_column() |> 
  group_by(cowmain_rc) |> 
  summarise(rowfirst = first(rowname), rowlast = last(rowname))

kb_align <- c("l", rep("r", ncol(df)-1))

df |> 
  ungroup() |> 
  select(-cowmain_rc) |> 
  rename(Year = 1) |> 
  kbl(format = "html", escape = FALSE, align = kb_align) |> 
  kable_styling(
    bootstrap_options = c("striped", "hover", "responsive"),
    font_size = 16,
    fixed_thead = T) |> 
  pack_rows("Private sector",
            kb_rows[kb_rows$cowmain_rc=="Private sector",]$rowfirst,
            kb_rows[kb_rows$cowmain_rc=="Private sector",]$rowlast,
            label_row_css = "border-bottom: 1px solid;background-color:#117777;color:#fff") |> 
  pack_rows("Public sector",
            kb_rows[kb_rows$cowmain_rc=="Public sector",]$rowfirst,
            kb_rows[kb_rows$cowmain_rc=="Public sector",]$rowlast,
            label_row_css = "border-bottom: 1px solid;background-color:#771155;color:#fff") |> 
  scroll_box(width = "100%", height = "700px", fixed_thead = T)

}
</script>
 
<script type="application/shiny-prerendered" data-context="server">
##### OUTPUT
# Render charts
output$plot <- renderPlot({
  # Density charts
  if (input$measure == "Union density"  &
      input$gg_layout %in% c("Horizontal", "Vertical")) {
    p <- union_density_patch(dataset(), dens_pal)
  } else if (input$measure == "Union density"  &
             input$gg_layout == "Stacked") {
    p <- union_density_stacked_gg(dataset())
  } else if (input$measure %in% c("Distribution (%)", "Distribution (N)") &
             input$gg_layout %in% c("Horizontal", "Vertical")) {
    p <- union_bars_patch(dataset_pop(), bar_pal)
  } else if (input$measure %in% c("Distribution (%)", "Distribution (N)") &
             input$gg_layout == "Stacked") {
    p <- union_area_gg(dataset_pop())
  }
  return(p)
}
, height = n_facets)

# Create plot title output
output$plot_title <- renderText({
  cat("title=", plot_title())
  })

# Create plot title output
output$table_title <- renderText({kb_title()})

# Create table output
output$table <- reactive({union_kbl(kbl_df())})

##### Data for download
# Reactive dataset
dataset_out <- reactive({
  
  if (input$measure == "Union density") {
  ds <- dataset() 
  ds <- ds |> 
      select(survyear,
             variable,
             varlevel,
             sector = cowmain_rc,
             union = union_bin,
             pop = n, 
             p_in_union = p, 
             p_population = p_pop)
  
  } else if (input$measure %in% c("Distribution (%)", "Distribution (N)")) {
    ds <- dataset_pop() 
    ds <- ds |> 
      select(survyear,
             variable,
             varlevel,
             sector = cowmain_rc,
             members = n, 
             p_members = p_memb)
  }
  
  ds
 })

output$data_preview <- renderTable({
  dataset_out() |> 
  head(20) 
})

output$data <- downloadHandler(
    filename = function() {
      paste(input$variable, ".csv", sep = "")
    },
    content = function(file) {
      write.csv(output_data(), file, row.names = FALSE)
    }
  )
</script>
 
<script type="application/shiny-prerendered" data-context="server-extras">
ojs_define <- function(..., .session = shiny::getDefaultReactiveDomain()) {
  quos <- rlang::enquos(...)
  vars <- rlang::list2(...)
  nm <- names(vars)
  if (is.null(nm)) {
    nm <- rep_len("", length(vars))
  }
  mapply(function(q, nm, val) {
    # Infer name, if possible
    if (nm == "") {
      tryCatch({
        nm <- rlang::as_name(q)
      }, error = function(e) {
        code <- paste(collapse = "\n", deparse(rlang::f_rhs(q)))
        stop("ojs_define() could not create a name for the argument: ", code)
      })
    }
    .session$output[[nm]] <- val
    outputOptions(.session$output, nm, suspendWhenHidden = FALSE)
    .session$sendCustomMessage("ojs-export", list(name = nm))
    NULL
  }, quos, nm, vars, SIMPLIFY = FALSE, USE.NAMES = FALSE)
  invisible()
}
</script>
</p>
<!--html_preserve-->
<script type="application/shiny-prerendered" data-context="dependencies">
{"type":"list","attributes":{},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["shinyjs-binding"]},{"type":"character","attributes":{},"value":["2.1.0.9006"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["srcjs"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["shinyjs-default-funcs.js"]},{"type":"NULL"},{"type":"character","attributes":{},"value":["<script>shinyjs.version = '2.1.0.9006';\nshinyjs.debug = false;\nShiny.addCustomMessageHandler('shinyjs-show', function(params) { shinyjs.debugMessage('shinyjs: calling function \"show\" with parameters:'); shinyjs.debugMessage(params); shinyjs.show(params);});\nShiny.addCustomMessageHandler('shinyjs-hide', function(params) { shinyjs.debugMessage('shinyjs: calling function \"hide\" with parameters:'); shinyjs.debugMessage(params); shinyjs.hide(params);});\nShiny.addCustomMessageHandler('shinyjs-toggle', function(params) { shinyjs.debugMessage('shinyjs: calling function \"toggle\" with parameters:'); shinyjs.debugMessage(params); shinyjs.toggle(params);});\nShiny.addCustomMessageHandler('shinyjs-enable', function(params) { shinyjs.debugMessage('shinyjs: calling function \"enable\" with parameters:'); shinyjs.debugMessage(params); shinyjs.enable(params);});\nShiny.addCustomMessageHandler('shinyjs-disable', function(params) { shinyjs.debugMessage('shinyjs: calling function \"disable\" with parameters:'); shinyjs.debugMessage(params); shinyjs.disable(params);});\nShiny.addCustomMessageHandler('shinyjs-toggleState', function(params) { shinyjs.debugMessage('shinyjs: calling function \"toggleState\" with parameters:'); shinyjs.debugMessage(params); shinyjs.toggleState(params);});\nShiny.addCustomMessageHandler('shinyjs-addClass', function(params) { shinyjs.debugMessage('shinyjs: calling function \"addClass\" with parameters:'); shinyjs.debugMessage(params); shinyjs.addClass(params);});\nShiny.addCustomMessageHandler('shinyjs-removeClass', function(params) { shinyjs.debugMessage('shinyjs: calling function \"removeClass\" with parameters:'); shinyjs.debugMessage(params); shinyjs.removeClass(params);});\nShiny.addCustomMessageHandler('shinyjs-toggleClass', function(params) { shinyjs.debugMessage('shinyjs: calling function \"toggleClass\" with parameters:'); shinyjs.debugMessage(params); shinyjs.toggleClass(params);});\nShiny.addCustomMessageHandler('shinyjs-html', function(params) { shinyjs.debugMessage('shinyjs: calling function \"html\" with parameters:'); shinyjs.debugMessage(params); shinyjs.html(params);});\nShiny.addCustomMessageHandler('shinyjs-onevent', function(params) { shinyjs.debugMessage('shinyjs: calling function \"onevent\" with parameters:'); shinyjs.debugMessage(params); shinyjs.onevent(params);});\nShiny.addCustomMessageHandler('shinyjs-removeEvent', function(params) { shinyjs.debugMessage('shinyjs: calling function \"removeEvent\" with parameters:'); shinyjs.debugMessage(params); shinyjs.removeEvent(params);});\nShiny.addCustomMessageHandler('shinyjs-alert', function(params) { shinyjs.debugMessage('shinyjs: calling function \"alert\" with parameters:'); shinyjs.debugMessage(params); shinyjs.alert(params);});\nShiny.addCustomMessageHandler('shinyjs-logjs', function(params) { shinyjs.debugMessage('shinyjs: calling function \"logjs\" with parameters:'); shinyjs.debugMessage(params); shinyjs.logjs(params);});\nShiny.addCustomMessageHandler('shinyjs-runjs', function(params) { shinyjs.debugMessage('shinyjs: calling function \"runjs\" with parameters:'); shinyjs.debugMessage(params); shinyjs.runjs(params);});\nShiny.addCustomMessageHandler('shinyjs-reset', function(params) { shinyjs.debugMessage('shinyjs: calling function \"reset\" with parameters:'); shinyjs.debugMessage(params); shinyjs.reset(params);});\nShiny.addCustomMessageHandler('shinyjs-delay', function(params) { shinyjs.debugMessage('shinyjs: calling function \"delay\" with parameters:'); shinyjs.debugMessage(params); shinyjs.delay(params);});\nShiny.addCustomMessageHandler('shinyjs-click', function(params) { shinyjs.debugMessage('shinyjs: calling function \"click\" with parameters:'); shinyjs.debugMessage(params); shinyjs.click(params);});\nShiny.addCustomMessageHandler('shinyjs-refresh', function(params) { shinyjs.debugMessage('shinyjs: calling function \"refresh\" with parameters:'); shinyjs.debugMessage(params); shinyjs.refresh(params);});<\/script><style>.shinyjs-hide { display: none !important; }<\/style>"]},{"type":"NULL"},{"type":"character","attributes":{},"value":["shinyjs"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["2.1.0.9006"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["htmltools-fill"]},{"type":"character","attributes":{},"value":["0.5.8.1"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["fill"]}]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["fill.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["htmltools"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["0.5.8.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["font-awesome"]},{"type":"character","attributes":{},"value":["6.5.2"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["fontawesome"]}]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["css/all.min.css","css/v4-shims.min.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["fontawesome"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["0.5.3"]}]}]}
</script>
<!--/html_preserve-->
<!--html_preserve-->
<script type="application/shiny-prerendered" data-context="execution_dependencies">
{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["packages"]}},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["packages","version"]},"class":{"type":"character","attributes":{},"value":["data.frame"]},"row.names":{"type":"integer","attributes":{},"value":[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90]}},"value":[{"type":"character","attributes":{},"value":["backports","base","base64url","callr","cli","codetools","compiler","data.table","datasets","digest","dplyr","evaluate","fansi","farver","fastmap","fontawesome","forcats","generics","ggfittext","ggplot2","ggrepel","ggtext","glue","graphics","grDevices","grid","gridtext","gtable","here","hms","htmltools","htmlwidgets","httpuv","igraph","jsonlite","kableExtra","knitr","later","lattice","lifecycle","lubridate","magrittr","methods","mime","patchwork","pillar","pkgconfig","processx","promises","ps","purrr","qs","R6","RApiSerialize","RColorBrewer","Rcpp","RcppParallel","readr","rlang","rmarkdown","rprojroot","rstudioapi","scales","secretbase","shiny","shinyjs","stats","stringfish","stringi","stringr","svglite","systemfonts","targets","tibble","tidyr","tidyselect","tidyverse","timechange","tools","tzdb","utf8","utils","vctrs","viridisLite","withr","xfun","xml2","xtable","yaml","zoo"]},{"type":"character","attributes":{},"value":["1.4.1","4.4.0","1.4","3.7.6","3.6.3","0.2-20","4.4.0","1.16.2","4.4.0","0.6.37","1.1.4","1.0.1","1.0.6","2.1.2","1.2.0","0.5.3","1.0.0","0.1.3","0.10.2","3.5.1","0.9.5","0.1.2","1.8.0","4.4.0","4.4.0","4.4.0","0.1.5","0.3.6","1.0.1","1.1.3","0.5.8.1","1.6.4","1.6.15","2.0.3","1.8.9","1.4.0","1.49","1.4.1","0.22-6","1.0.4","1.9.3","2.0.3","4.4.0","0.12","1.3.0","1.9.0","2.0.3","3.8.4","1.3.2","1.8.1","1.0.2","0.27.2","2.5.1","0.1.4","1.1-3","1.0.13-1","5.1.7","2.1.5","1.1.4","2.29","2.0.4","0.16.0","1.3.0.9000","1.0.2","1.10.0","2.1.0.9006","4.4.0","0.16.0","1.8.4","1.5.1","2.1.3","1.1.0","1.8.0","3.2.1","1.3.1","1.2.1","2.0.0","0.3.0","4.4.0","0.4.0","1.2.4","4.4.0","0.6.5","0.4.2","3.0.2","0.49","1.3.6","1.8-4","2.3.8","1.8-12"]}]}]}
</script>
<!--/html_preserve-->


<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /container fluid -->

<script type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (_event) {
  if (window.bslib.Card) {
    window.bslib.Card.initializeAllCards();
  }
}); 
</script>
  



</body></html>